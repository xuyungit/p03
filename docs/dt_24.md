# dt_24 相关记录

## 数据生成

```bash
uv run python src/data/generate_custom_bridge_params.py --config src/data/temp_delta_24h_new2.json --out data/augmented/dt_24hours_new2.csv

uv run python src/data/generate_custom_bridge_params.py --config src/data/temp_delta_24h_new3.json --out data/augmented/dt_24hours_new3.csv

uv run python src/data/bridge_reaction_sampling.py --params data/augmented/dt_24hours_new2.csv --out data/augmented/dt_24hours_data_new2.csv

uv run python src/data/bridge_reaction_sampling.py --params data/augmented/dt_24hours_new3.csv --out data/augmented/dt_24hours_data_new3.csv

uv run python src/data/generate_custom_bridge_params.py --config data/temp_delta_2_span.json --out data/augmented/custom_params_2span.csv

uv run python src/data/bridge_reaction_sampling.py --params data/augmented/custom_params_2span.csv --out data/augmented/dt_24hours_data_2_span.csv

uv run python src/data/bridge_reaction_sampling.py --params data/augmented/dt_24hours_new2.csv --out data/augmented/dt_24hours_data_new2_363.csv --span-lengths 30:60:30

uv run python src/data/bridge_reaction_sampling.py --params data/augmented/dt_24hours_new3.csv --out data/augmented/dt_24hours_data_new3_363.csv --span-lengths 30:60:30

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new.csv  \
      --output-csv data/augmented/dt_24hours_data_new_round4.csv  \
      --round-digits 4 \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new.csv  \
      --output-csv data/augmented/dt_24hours_data_new_rsensor0501.csv  \
      --apply-angle-sensor-noise \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new2.csv  \
      --output-csv data/augmented/dt_24hours_data_new2_rsensor0501.csv  \
      --apply-angle-sensor-noise \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new2.csv  \
      --output-csv data/augmented/dt_24hours_data_new2_round4.csv  \
      --round-digits 4 \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new3.csv  \
      --output-csv data/augmented/dt_24hours_data_new3_rsensor0501.csv  \
      --apply-angle-sensor-noise \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new3.csv  \
      --output-csv data/augmented/dt_24hours_data_new3_round4.csv  \
      --round-digits 4 \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new2_363.csv  \
      --output-csv data/augmented/dt_24hours_data_new2_363_round4.csv  \
      --round-digits 4 \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
      --input-csv data/augmented/dt_24hours_data_new3_363.csv  \
      --output-csv data/augmented/dt_24hours_data_new3_363_round4.csv  \
      --round-digits 4 \
      --columns-re "^theta_.+rad$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new_rsensor0501.csv \
    --output-csv data/augmented/dt_24hours_data_new_rsensor0501_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new_round4.csv \
    --output-csv data/augmented/dt_24hours_data_new_round4_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new2_rsensor0501.csv \
    --output-csv data/augmented/dt_24hours_data_new2_rsensor0501_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new2_round4.csv \
    --output-csv data/augmented/dt_24hours_data_new2_round4_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new3_rsensor0501.csv \
    --output-csv data/augmented/dt_24hours_data_new3_rsensor0501_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new3_round4.csv \
    --output-csv data/augmented/dt_24hours_data_new3_round4_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new2_363_round4.csv \
    --output-csv data/augmented/dt_24hours_data_new2_363_round4_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"

uv run python src/data/add_data_perturbation.py \
    --input-csv data/augmented/dt_24hours_data_new3_363_round4.csv \
    --output-csv data/augmented/dt_24hours_data_new3_363_round4_noise5.csv \
    --add-proportional-noise 0.05 \
    --columns-re "^R_.+_kN$"
```

## 多文件联合拟合

从版本 v2 开始，`fit_multi_case_v2.py` 支持多个数据文件的联合拟合。多个文件会被拼接成一个连续的时间序列，时间平滑约束（temporal regularization）会自动应用于文件边界处，确保整个序列的温度梯度变化平滑。

**默认行为**：
- Settlement A 固定为 0.0（作为相对沉降的参考点）
- 只优化 3 个沉降参数（B, C, D）
- 这避免了参数空间的平移不确定性

### 使用方法

**1. 基本用法（使用默认配置）：**

```bash
# 使用两个数据文件进行拟合，Settlement A 自动固定为 0
uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new.csv \
    --data data/augmented/dt_24hours_data_new2.csv \
    --maxiter 500 \
    --output results/multi_file_fit.csv
```

**2. 固定 KV 参数（推荐，减少参数空间）：**

```bash
# 固定 KV + 固定 Settlement A，最精简的参数空间
uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new.csv \
    --data data/augmented/dt_24hours_data_new2.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --maxiter 500 \
    --output results/multi_file_fit_kv.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_2_span.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --maxiter 500 \
    --temp-segments 2 \
    --output results/multi_file_fit_kv_2_span.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --maxiter 500 \
    --output results/multi_file_fit_kv.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-displacements --displacement-weight 1.0 \
    --maxiter 500 \
    --output results/multi_file_fit_kv.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-displacements --displacement-weight 1.0 \
    --use-rotations --rotation-weight 1.0 \
    --maxiter 500 \
    --output results/multi_file_fit_kv.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --maxiter 500 \
    --output results/multi_file_fit_kv.csv


uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2_round4.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --maxiter 500 \
    --output results/multi_file_fit_kv.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2_round4.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --use-span-rotations --span-rotation-weight 1.0 \
    --maxiter 100 \
    --output results/r_6_theta_round4_fit_kv.csv

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new2_round4_noise5.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --use-span-rotations --span-rotation-weight 1.0 \
    --maxiter 100 \
    --output results/r_n5_6_theta_round4_fit_kv.csv
```

**3. 拟合全部 4 个沉降（不推荐，仅用于特殊需求）：**

```bash
# 不固定 Settlement A，拟合全部 4 个沉降值
uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new.csv \
    --data data/augmented/dt_24hours_data_new2.csv \
    --no-fix-first-settlement \
    --maxiter 500 \
    --output results/multi_file_fit_all_settlements.csv
```

**或使用便捷脚本：**

```bash
bash scripts/run_multi_file_fit.sh
```

### 工作原理

1. **数据拼接**：多个CSV文件按指定顺序拼接，`sample_id` 重新编号为连续序列
2. **时间平滑约束**：温度梯度的时序约束 (temporal regularization) 应用于所有相邻样本，包括文件边界处
3. **结构参数一致性**：验证所有文件的结构参数（沉降、EI因子、Kv因子）保持一致

### 优势

- 可以使用更多数据点进行联合优化，提高拟合精度
- 跨文件边界的平滑约束确保温度梯度时序连续性
- 适用于长时间序列的分段数据

## 使用神经网络作为对比

```bash
uv run python src/models/bridge_nn.py \
      --train-csv data/augmented/2d01_1500.csv \
      data/augmented/2d01_1500_round4_noise3_train.csv \
      data/augmented/2d01_1500_round4_noise5_train.csv \
      data/augmented/2d01_5000_round4_noise3_train.csv \
      data/augmented/2d01_5000_round4_noise5_train.csv \
      --test-csv data/augmented/2d01_1500_round4_noise3_test.csv \
      data/augmented/2d01_5000_round4_noise3_test.csv \
      data/augmented/dt_24hours_data_new_round4_noise5.csv \
      data/augmented/dt_24hours_data_new2_round4_noise5.csv \
      data/augmented/dt_24hours_data_new3_round4_noise5.csv \
      --input-cols-re '^R_.+_kN$, ^theta_[A-D].+rad$, kv_.+$' \
      --target-cols-re '^settlement_[b-d]_mm$, ^ei_factor_s\d+$, ^dT_s\d+_C$' \
      --no-augment-flip \
      --dropout 0 --print-freq 100 --epochs 2500 --lr 1e-4 --early-stopping --patience 750   --scheduler cosine --warmup-steps 50 \
      --num-layers 6 --hidden-dim 256 --batch-size 16384 --model-type res_mlp

uv run python src/models/bridge_nn.py \
      --train-csv data/augmented/2d01_1500.csv \
      data/augmented/2d01_1500_round4_noise3_train.csv \
      data/augmented/2d01_1500_round4_noise5_train.csv \
      data/augmented/2d01_5000_round4_noise3_train.csv \
      data/augmented/2d01_5000_round4_noise5_train.csv \
      --test-csv data/augmented/2d01_1500_round4_noise3_test.csv \
      data/augmented/2d01_5000_round4_noise3_test.csv \
      data/augmented/dt_24hours_data_new_round4_noise5.csv \
      data/augmented/dt_24hours_data_new2_round4_noise5.csv \
      data/augmented/dt_24hours_data_new3_round4_noise5.csv \
      --input-cols-re '^R_.+_kN$, ^theta_[A-D].+rad$, theta_S1-5_6L_rad, theta_S2-4_6L_rad, theta_S3-5_6L_rad, kv_.+$' \
      --target-cols-re '^settlement_[b-d]_mm$, ^ei_factor_s\d+$, ^dT_s\d+_C$' \
      --no-augment-flip \
      --dropout 0 --print-freq 100 --epochs 2500 --lr 1e-4 --early-stopping --patience 750   --scheduler cosine --warmup-steps 50 \
      --num-layers 6 --hidden-dim 256 --batch-size 16384 --model-type res_mlp

```


## 傅里叶温度梯度

```bash
uv run python src/models/bridge_2d_fit.py \
    --data data/augmented/dt_24hours_data_new_round4_noise5.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --maxiter 100 \
    --output results/r_n5_6_theta_round4_fit_kv.csv \
    --temp-basis fourier --fourier-harmonics 10

uv run python src/models/bridge_2d_fit.py \
    --data data/augmented/dt_24hours_data_new_rsensor0501_noise5.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --maxiter 100 \
    --output results/r_n5_6_theta_round4_fit_kv.csv \
    --temp-basis fourier --fourier-harmonics 10

uv run python src/models/bridge_2d_fit.py \
    --data data/augmented/dt_24hours_data_new_rsensor0501_noise5.csv \
    --fixed-kv 1.21875633217039 0.575148946195117 1.03133789506241 0.952294668480702 \
    --use-rotations --rotation-weight 1.0 \
    --maxiter 100 \
    --output results/r_n5_6_theta_round4_fit_kv.csv \
    --temp-basis fourier --fourier-harmonics 10

uv run python src/models/fit_multi_case_v2.py \
    --data data/augmented/dt_24hours_data_new3_363_round4_noise5.csv \
    --fixed-kv 1.2891632775508988 1.2969883848242527 0.8480060335586834 1.1405218884143073 \
    --maxiter 100 \
    --output results/r_n5_6_theta_round4_fit_kv.csv

```
